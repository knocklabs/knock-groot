name: publish package
on:
  release:
    types: [created]
jobs:
  publish-brew:
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "16.4.x"
      - run: yarn

      - name: Pack tarball
        run: npx oclif pack tarballs -t darwin-x64 --no-xz

      # - name: Query tarball
      #   id: tarball
      #   run: echo "filename=$(ls ./dist/*darwin-x64.tar.gz | head -1 | xargs -n 1 basename)" >> $GITHUB_OUTPUT

      - name: Set tarball vars
        id: tarball
        run: |
          FILENAME=$(ls ./dist/*darwin-x64.tar.gz | head -1 | xargs -n 1 basename)
          echo "filename=${FILENAME}" >> $GITHUB_OUTPUT
          echo "download_url=https://github.com/knocklabs/knock-groot/releases/download/${GITHUB_REF_NAME}/${FILENAME}" >> $GITHUB_OUTPUT

      # echo "filename=$(ls ./dist/*darwin-x64.tar.gz | head -1 | xargs -n 1 basename)" >> $GITHUB_OUTPUT
      # echo "download_url=$(ls ./dist/*darwin-x64.tar.gz | head -1 | xargs -n 1 basename)" >> $GITHUB_OUTPUT

      # - run: mv dist/*-darwin-x64.tar.gz dist/groot-${GITHUB_REF_NAME}-darwin-x64.tar.gz

      - name: Upload tarball
        run: gh release upload ${GITHUB_REF_NAME} ./dist/${{ steps.tarball.outputs.filename }}

      - name: Check download url
        run: echo "${{ steps.tarball.outputs.download_url }}"

      # - name: Set SHA
      #   id: shasum
      #   run: |
      #     echo ::set-output name=sha::"$(shasum -a 256 dist/*-darwin-x64.tar.gz | awk '{printf $1}')"

      - uses: mislav/bump-homebrew-formula-action@v2
        if: "!contains(github.ref, '-')" # skip prereleases
        with:
          formula-name: groot
          homebrew-tap: knocklabs/homebrew-tap
          download-url: ${{ steps.tarball.outputs.download_url }}
          commit-message: |
            {{formulaName}} {{version}}

            Created by https://github.com/mislav/bump-homebrew-formula-action
        env:
          COMMITTER_TOKEN: ${{ secrets.COMMITTER_TOKEN }}

  # publish-npm:
